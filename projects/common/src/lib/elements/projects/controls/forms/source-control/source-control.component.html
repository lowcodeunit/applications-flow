<div [formGroup]="FormGroup">
  <div class="card" *ngIf="OrganizationFormControl?.valid || !Loading">
    <mat-form-field
      class="mat-full-width with-hint"
      *ngIf="OrganizationOptions?.length > 0"
    >
      <mat-icon class="org-icon" matPrefix>groups</mat-icon>

      <mat-select
        [formControlName]="SourceControlRoot + 'organization'"
        placeholder="Organization"
        (selectionChange)="OrganizationChanged($event)"
        [disabled]="Loading || OrganizationDisabled"
        required
      >
        <ng-container *ngFor="let orgOpt of OrganizationOptions">
          <mat-option [value]="orgOpt.Name">
            {{ orgOpt.Name }}
          </mat-option>
        </ng-container>
      </mat-select>

      <mat-icon matSuffix (click)="RefreshOrganizations()"> refresh </mat-icon>

      <a
        matSuffix
        href="/.oauth/github?oauth-force-edit=true"
        title="Re-authorize Organizations"
        target="_blank"
      >
        <mat-icon> launch </mat-icon>
      </a>

      <mat-hint>
        If you don't have an organization or would like to create a new one,
        <a
          mat-button
          href="https://github.com/account/organizations/new"
          target="_blank"
        >
          start here
        </a>
        .
      </mat-hint>
    </mat-form-field>
  </div>

  <div
    class="card"
    *ngIf="RepositoryFormControl?.valid || (OrganizationFormControl?.valid && !Loading)"
  >
    <mat-form-field class="mat-full-width">
      <mat-icon class="org-icon" matPrefix>description</mat-icon>

      <mat-select
        [formControlName]="SourceControlRoot + 'repository'"
        [placeholder]="
          OrganizationFormControl?.valid
            ? 'Repository'
            : 'Repository (select organization first)'
        "
        [disabled]="!OrganizationFormControl?.valid || Loading || RepositoryDisabled"
        (selectionChange)="RepositoryChanged($event)"
        *ngIf="!CreatingRepository"
        required
      >
        <ng-container *ngFor="let repoOpt of RepositoryOptions">
          <mat-option [value]="repoOpt.Name">
            {{ repoOpt.Name }}
          </mat-option>
        </ng-container>
      </mat-select>

      <input
        matInput
        placeholder="Repository (creates new if does not exist)"
        [formControlName]="SourceControlRoot + 'repository'"
        *ngIf="CreatingRepository"
        [fxHide]="Loading || RepositoryDisabled"
        required
      />

      <mat-icon
        matSuffix
        (click)="CreateRepository()"
        [fxHide]="Loading || RepositoryDisabled"
        *ngIf="!CreatingRepository && OrganizationFormControl?.valid"
      >
        add_circle
      </mat-icon>

      <mat-icon
        matSuffix
        color="primary"
        (click)="SaveRepository()"
        *ngIf="CreatingRepository && RepositoryFormControl?.valid"
      >
        save
      </mat-icon>

      <mat-icon
        matSuffix
        (click)="CancelCreateRepository()"
        *ngIf="CreatingRepository"
      >
        cancel
      </mat-icon>
    </mat-form-field>
  </div>

  <div
    class="card"
    *ngIf="
      (BranchesFormControl?.valid ||
        (OrganizationFormControl?.valid && RepositoryFormControl?.valid && !Loading)) &&
      !CreatingRepository &&
      UseBranches
    "
  >
    <mat-form-field class="mat-full-width">
      <mat-icon class="org-icon" matPrefix>account_tree</mat-icon>

      <mat-label>Selected Branches</mat-label>

      <mat-autocomplete
        (optionSelected)="BranchOptionSelected($event)"
        #branchOptions="matAutocomplete"
      >
        <ng-container *ngFor="let branchOpt of BranchOptions">
          <mat-option [value]="branchOpt.Name">
            {{ branchOpt.Name }}
          </mat-option>
        </ng-container>
      </mat-autocomplete>

      <mat-chip-list #selectedBranches>
        <mat-chip
          [removable]="true"
          (removed)="RemoveBranchOption(selBranch)"
          *ngFor="let selBranch of SelectedBranches"
        >
          {{ selBranch }}
          <mat-icon matChipRemove>cancel</mat-icon>
        </mat-chip>

        <input
          matInput
          placeholder="New Branch..."
          [formControlName]="SourceControlRoot + 'branches'"
          #branches
          [matAutocomplete]="branchOptions"
          [matChipInputFor]="selectedBranches"
          [matChipInputSeparatorKeyCodes]="SeparatorKeysCodes"
          [matChipInputAddOnBlur]="true"
          (matChipInputTokenEnd)="AddBranchOption($event)"
          [disabled]="Loading || BranchesDisabled"
          required
        />
      </mat-chip-list>
    </mat-form-field>

    <mat-form-field
      class="mat-full-width with-hint"
      *ngIf="OrganizationOptions?.length > 0"
    >
      <mat-icon class="org-icon" matPrefix>account_tree</mat-icon>

      <mat-select
        [formControlName]="SourceControlRoot + 'mainBranch'"
        placeholder="Main Branch"
        [disabled]="Loading || BranchesDisabled"
        [fxShow]="SelectedBranchesFormControl?.length > 1"
        required
      >
        <ng-container *ngFor="let branch of SelectedBranches">
          <mat-option [value]="branch">
            {{ branch }}
          </mat-option>
        </ng-container>
      </mat-select>

      <mat-icon matSuffix (click)="RefreshOrganizations()"> refresh </mat-icon>

      <a
        matSuffix
        href="/.oauth/github?oauth-force-edit=true"
        title="Re-authorize Organizations"
        target="_blank"
      >
        <mat-icon> launch </mat-icon>
      </a>

      <mat-hint>
        If you don't have an organization or would like to create a new one,
        <a
          mat-button
          href="https://github.com/account/organizations/new"
          target="_blank"
        >
          start here
        </a>
        .
      </mat-hint>
    </mat-form-field>
  </div>

  <div *ngIf="Loading">
    <div class="spread">
      <lcu-loader style="margin: auto" [loading]="true"></lcu-loader>

      <div class="margin-3">
        <h4 class="mat-title" *ngIf="!OrganizationFormControl?.valid">
          Loading organizations
        </h4>

        <h4 class="mat-title" *ngIf="OrganizationFormControl?.valid && !RepositoryFormControl?.valid">
          Loading repositories
        </h4>

        <h4 class="mat-title" *ngIf="RepositoryFormControl?.valid && !BranchesFormControl?.valid">
          Loading branches
        </h4>
      </div>
    </div>
  </div>
</div>
